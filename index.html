<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>수학 퀴즈</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>수학 퀴즈</h1>
      <p>이름과 학년을 입력하고 시작하세요</p>
    </div>

    <div class="card">
      <div class="form-group">
        <label for="studentName">이름</label>
        <input type="text" id="studentName" placeholder="이름을 입력하세요" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="grade">학년</label>
        <select id="grade">
          <option value="">학년을 선택하세요</option>
          <option value="1">중학교 1학년</option>
          <option value="2">중학교 2학년</option>
          <option value="3">중학교 3학년</option>
        </select>
      </div>

      <div class="form-group">
        <label for="classNum">반</label>
        <input type="text" id="classNum" placeholder="반을 입력하세요 (예: 1반, A반)" autocomplete="off">
      </div>

      <div id="errorMsg" class="message message-error hidden"></div>

      <button id="startBtn" class="btn btn-primary" onclick="startQuiz()">
        퀴즈 시작하기
      </button>
    </div>

    <div id="loadingArea" class="loading hidden">
      <div class="spinner"></div>
      <p style="margin-top:12px">퀴즈를 불러오는 중...</p>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script>
    function startQuiz() {
      var name = document.getElementById('studentName').value.trim();
      var grade = document.getElementById('grade').value;
      var classNum = document.getElementById('classNum').value.trim();
      var errorMsg = document.getElementById('errorMsg');
      var startBtn = document.getElementById('startBtn');
      var loadingArea = document.getElementById('loadingArea');

      errorMsg.classList.add('hidden');

      if (!name) {
        showError('이름을 입력해주세요.');
        return;
      }
      if (!grade) {
        showError('학년을 선택해주세요.');
        return;
      }
      if (!classNum) {
        showError('반을 입력해주세요.');
        return;
      }

      // 학생 정보 저장
      sessionStorage.setItem('studentName', name);
      sessionStorage.setItem('grade', grade);
      sessionStorage.setItem('classNum', classNum);

      // 이전 답안 초기화
      sessionStorage.removeItem('quizAnswers');
      sessionStorage.removeItem('quizResult');

      // Apps Script URL이 설정되지 않은 경우 (로컬 테스트 모드)
      if (!MathQuiz.config.APPS_SCRIPT_URL) {
        sessionStorage.setItem('testMode', 'true');
        // 로컬에 배포된 퀴즈가 있으면 그걸 사용
        var localQuiz = localStorage.getItem('localQuiz');
        if (localQuiz) {
          sessionStorage.setItem('quizData', localQuiz);
        }
        window.location.href = 'quiz.html';
        return;
      }

      // 퀴즈 불러오기
      startBtn.disabled = true;
      loadingArea.classList.remove('hidden');

      MathQuiz.api.loadQuiz()
        .then(function(res) {
          if (res.success) {
            sessionStorage.setItem('quizData', JSON.stringify(res.data));
            window.location.href = 'quiz.html';
          } else {
            showError(res.error || '퀴즈를 불러올 수 없습니다.');
            startBtn.disabled = false;
            loadingArea.classList.add('hidden');
          }
        })
        .catch(function(err) {
          showError('서버에 연결할 수 없습니다. 인터넷 연결을 확인해주세요.');
          startBtn.disabled = false;
          loadingArea.classList.add('hidden');
        });
    }

    function showError(msg) {
      var el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    // 엔터키로 시작
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') startQuiz();
    });
  </script>
</body>
</html>
